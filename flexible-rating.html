<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-form-element-behavior/iron-form-element-behavior.html">
<link rel="import" href="../iron-validatable-behavior/iron-validatable-behavior.html">

<!--
An element providing a star rating that allows fractions.

Example 1:

    <flexible-rating value="3.6" read-only="true">
    </flexible-rating>

Example 2:

    <flexible-rating value="4">
    </flexible-rating>

### Styling

`<flexible-rating>` provides the following custom properties and mixins
for styling:

Custom property | Description | Default
----------------|-------------|----------
`--rating-filled-color` | Fill color of the selected rating shapes | #ffac33
`--rating-unfilled-color` | Fill color of remaining rating shapes | #ccd6dd

@demo demo/index.html
-->
<dom-module id="flexible-rating">
    <template>
        <style>
            :host {
              cursor: default;
              -webkit-touch-callout: none;
              -webkit-user-select: none;
              -khtml-user-select: none;
              -moz-user-select: none;
              -ms-user-select: none;
              user-select: none;
            }

            .star-wrapper {
                display: inline-block;
            }

            .star-wrapper ::content > span {
              display: inline-block;
              position: relative;
              color: var(--rating-unfilled-color, #ccd6dd);
            }

            .star-wrapper ::content > span > span {
              display: block;
              position: absolute;
              top: 0px;
              bottom: 0px;
              overflow: hidden;
              color: var(--rating-filled-color, #ffac33);
            }

            /* Select all stars up to the hovered one */

            .star-wrapper[data-read-only=false] ::content > span {
                cursor: pointer;
            }

            /* Show all stars */
            .star-wrapper:hover[data-read-only=false] ::content > span > span {
                width: 100% !important;
            }
            :host[invalid] {
              background-color: red;
            }

            /* Hide all after the hovered one */
            .star-wrapper:hover[data-read-only=false] ::content > span:hover ~ span > span {
                width: 0% !important;
            }

        </style>
        <!-- local DOM goes here -->
        <div class="star-wrapper" data-read-only$="[[_boolToString(readOnly)]]">
        <template is="dom-repeat" items="{{_possibleValues}}"><!--
        --><span on-tap="_starClicked" data-star-id$="{{index}}">&#x2605;<!--
            --><span style$="width:[[_calculateWidth(index, value)]]">&#x2605;</span><!--
            --></span><!--
        --></template>
        </div>
    </template>

    <script>
    Polymer({
        is: 'flexible-rating',
        behaviors:
          [
            Polymer.IronFormElementBehavior,
            Polymer.IronValidatableBehavior,
          ],
        properties: {
            /**
            *   Whether the rating should be read-only or clickable.
            */
            readOnly: {
                type: Boolean,
                value: false,
            },

            /**
            *   The maximum number of stars possible.
            */
            max: {
                type: Number,
                value: 5
            },
            /**
            *   The number of stars that are marked. Can be a float and can show partial stars.
            */
            value: {
                type: Number,
                value: 0,
                notify: true,
                reflectToAttribute: true,
            },

            _possibleValues: {
              type: Array,
              computed: '_computePossibleValues(max)',
            }
        },
        listeners: {
          'value-changed': 'validateNotZero',
        },
        validateNotZero: function() {
          if (this.value != 0)
            this.validate();
        },
        _getValidity: function(value) {
            if (this.value == 0) return false;

            return true;
        },
        ready: function() {
        },
        _computePossibleValues: function(max) {
            values = [];
            for (var i = 1; i <= max; i++) {
                values.push(i);
            }
            return values;
        },

        _calculateWidth: function(star, value) {
            if (value >= star + 1){
                return "100%";
            }
            else if (value - star >= 0) {
                return (value-star) * 100 + "%";
            }
            else return "0%";
        },
        _starClicked: function(e) {
            if (this.readOnly)
                return;

            var star;
            if (e.currentTarget.dataset !== undefined)
                star = parseInt(e.currentTarget.dataset.starId);
            else
                star = parseInt(e.currentTarget.getAttribute('data-star-id'));
            this.setAttribute('value', star + 1);
        },

        _boolToString: function(bool) {
            return bool ? "true" : "false";
        },

    });
    </script>
<dom-module>
